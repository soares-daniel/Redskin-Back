name: Build and Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Set up Python Environment
      uses: actions/setup-python@v2
      with:
        python-version: '3.11.4'
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up .env
      run: |
        echo "ewogICAgIlNFUlZFUl9IT1NUIjogImxvY2FsaG9zdCIsCiAgICAiU0VSVkVSX1BPUlQiOiAiODAwMCIsCiAgICAiU0VSVkVSX1dPUktFUlMiOiAiNCIsCiAgICAiTE9HR0lOR19GT1JNQVQiOiAiPGdyZWVuPnt0aW1lOkhIOm1tOnNzLlNTU1p9PC9ncmVlbj4gfCA8bGV2ZWw+e2xldmVsOiA8OH08L2xldmVsPiB8IDxjeWFuPntuYW1lfTwvY3lhbj46PGN5YW4+e2Z1bmN0aW9ufTwvY3lhbj46PGN5YW4+e2xpbmV9PC9jeWFuPiAtIDxsZXZlbD57bWVzc2FnZX08L2xldmVsPiIsCiAgICAiUE9TVEdSRVNfVVJJIjogInBvc3RncmVzcWwrYXN5bmNwZzovL2RidGVzdF9tdHBlX3VzZXI6eWkzUkZKWlBCVkxYV1MyVXRPMlEzRkhuM3JVaDN1dkZAZHBnLWNocGxrN3FrNzI4aXZ2b2plMHMwLWEuZnJhbmtmdXJ0LXBvc3RncmVzLnJlbmRlci5jb20vZGJ0ZXN0X210cGUiLAogICAgIlBPU1RHUkVTX05BTUUiOiAiZGJ0ZXN0X210cGUiLAogICAgIlBPU1RHUkVTX0hPU1QiOiAiZHBnLWNocGxrN3FrNzI4aXZ2b2plMHMwLWEuZnJhbmtmdXJ0LXBvc3RncmVzLnJlbmRlci5jb20iLAogICAgIlBPU1RHUkVTX1BPUlQiOiAiNTQzMiIsCiAgICAiUE9TVEdSRVNfVVNFUiI6ICJkYnRlc3RfbXRwZV91c2VyIiwKICAgICJQT1NUR1JFU19QQVNTV09SRCI6ICJ5aTNSRkpaUEJWTFhXUzJVdE8yUTNGSG4zclVoM3V2RiIsCiAgICAiUE9TVEdSRVNfU0NIRU1BIjogInBvc3RncmVzcWwrYXN5bmNwZyIsCiAgICAiQVBJX1RPS0VOIjogIiIsCiAgICAiQVVUSF9UT0tFTiI6ICIiLAogICAgIkRCX1RJTUVPVVQiOiAiNSIsCiAgICAiREJfUE9PTF9TSVpFIjogIjEwMCIsCiAgICAiREJfTUFYX1BPT0xfQ09OIjogIjgwIiwKICAgICJEQl9QT09MX09WRVJGTE9XIjogIjIwIiwKICAgICJJU19EQl9FQ0hPX0xPRyI6ICJ0cnVlIiwKICAgICJJU19EQl9FWFBJUkVfT05fQ09NTUlUIjogImZhbHNlIiwKICAgICJJU19EQl9GT1JDRV9ST0xMQkFDSyI6ICJ0cnVlIiwKICAgICJKV1RfU0VDUkVUX0tFWSI6ICIyeVg0Z1pDOXFDYWpxdmhqVDBBOGU0TWMiLAogICAgIkpXVF9TVUJKRUNUIjogInVzZXJzIiwKICAgICJKV1RfVE9LRU5fUFJFRklYIjogIlRva2VuIiwKICAgICJKV1RfQUxHT1JJVEhNIjogIkhTMjU2IiwKICAgICJKV1RfTUlOIjogIjYwIiwKICAgICJKV1RfSE9VUiI6ICIyNCIsCiAgICAiSldUX0RBWSI6ICI3IiwKICAgICJJU19BTExPV0VEX0NSRURFTlRJQUxTIjogInRydWUiLAogICAgIkhBU0hJTkdfQUxHT1JJVEhNX0xBWUVSXzEiOiAiYmNyeXB0IiwKICAgICJIQVNISU5HX0FMR09SSVRITV9MQVlFUl8yIjogImFyZ29uMiIsCiAgICAiSEFTSElOR19TQUxUIjogIjZkMTUzZTVkOWE4MTNmNTciLAogICAgIkRJU0NPUkRfQ0xJRU5UX0lEIjogIjExMjExNTMzMjUyODc2MDQzOTciLAogICAgIkRJU0NPUkRfU0VSVkVSX1BPUlQiOiAiNTA2OSIsCiAgICAiRElTQ09SRF9OT1RJRklDQVRJT05fRU5EUE9JTlQiOiAiL25vdGlmaWNhdGlvbnMiLAogICAgIlNVUEVSX1VTRVIiOiAic3VwZXJ1c2VyIiwKICAgICJTVVBFUl9QQVNTIjogIkZSR0dVNjglXjh3WWUiCn0K" | base64 -d > env.json
        python -m json.tool env.json > env.json.tmp && mv env.json.tmp env.json
        python -c "import json; import os; with open('env.json') as f: data = json.load(f); for k, v in data.items(): os.system(f'echo {k}={v} >> .env')"
        rm env.json



    - name: Run Tests
      run: |
        pytest